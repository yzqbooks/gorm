"use strict";(self.webpackChunkgorm=self.webpackChunkgorm||[]).push([[9850],{3905:function(e,n,t){t.d(n,{Zo:function(){return d},kt:function(){return g}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var o=a.createContext({}),u=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},d=function(e){var n=u(e.components);return a.createElement(o.Provider,{value:n},e.children)},m={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},p=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,o=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),p=u(t),g=r,c=p["".concat(o,".").concat(g)]||p[g]||m[g]||l;return t?a.createElement(c,i(i({ref:n},d),{},{components:t})):a.createElement(c,i({ref:n},d))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=p;var s={};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var u=2;u<l;u++)i[u]=t[u];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}p.displayName="MDXCreateElement"},202:function(e,n,t){t.r(n),t.d(n,{assets:function(){return d},contentTitle:function(){return o},default:function(){return g},frontMatter:function(){return s},metadata:function(){return u},toc:function(){return m}});var a=t(7462),r=t(3366),l=(t(7294),t(3905)),i=["components"],s={title:"GORM 2.0 \u53d1\u5e03\u8bf4\u660e",layout:"page"},o=void 0,u={unversionedId:"v2_release_note",id:"v2_release_note",title:"GORM 2.0 \u53d1\u5e03\u8bf4\u660e",description:"GORM 2.0 \u5b8c\u5168\u4ece\u96f6\u5f00\u59cb\uff0c\u5f15\u5165\u4e86\u4e00\u4e9b\u4e0d\u517c\u5bb9\u7684 API \u53d8\u66f4\u548c\u8bb8\u591a\u6539\u8fdb",source:"@site/docs/v2_release_note.md",sourceDirName:".",slug:"/v2_release_note",permalink:"/gorm/docs/v2_release_note",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/v2_release_note.md",tags:[],version:"current",frontMatter:{title:"GORM 2.0 \u53d1\u5e03\u8bf4\u660e",layout:"page"},sidebar:"tutorialSidebar",previous:{title:"\u66f4\u65b0",permalink:"/gorm/docs/update"},next:{title:"\u7f16\u5199\u9a71\u52a8",permalink:"/gorm/docs/write_driver"}},d={},m=[{value:"\u5982\u4f55\u5347\u7ea7",id:"\u5982\u4f55\u5347\u7ea7",level:2},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:3},{value:"\u5feb\u901f\u5f00\u59cb",id:"\u5feb\u901f\u5f00\u59cb",level:3},{value:"\u4e3b\u8981\u7279\u6027",id:"\u4e3b\u8981\u7279\u6027",level:2},{value:"Context \u652f\u6301",id:"context-\u652f\u6301",level:4},{value:"\u6279\u91cf\u63d2\u5165",id:"\u6279\u91cf\u63d2\u5165",level:4},{value:"\u9884\u7f16\u8bd1\u6a21\u5f0f",id:"\u9884\u7f16\u8bd1\u6a21\u5f0f",level:4},{value:"DryRun \u6a21\u5f0f",id:"dryrun-\u6a21\u5f0f",level:4},{value:"Joins \u9884\u52a0\u8f7d",id:"joins-\u9884\u52a0\u8f7d",level:4},{value:"Find To Map",id:"find-to-map",level:4},{value:"Create From Map",id:"create-from-map",level:4},{value:"FindInBatches",id:"findinbatches",level:4},{value:"\u5d4c\u5957\u4e8b\u52a1",id:"\u5d4c\u5957\u4e8b\u52a1",level:4},{value:"SavePoint\uff0cRollbackTo",id:"savepointrollbackto",level:4},{value:"\u547d\u540d\u53c2\u6570",id:"\u547d\u540d\u53c2\u6570",level:4},{value:"\u5206\u7ec4\u6761\u4ef6",id:"\u5206\u7ec4\u6761\u4ef6",level:4},{value:"\u5b50\u67e5\u8be2",id:"\u5b50\u67e5\u8be2",level:4},{value:"Upsert",id:"upsert",level:4},{value:"Locking",id:"locking",level:4},{value:"Optimizer/Index/Comment Hint",id:"optimizerindexcomment-hint",level:4},{value:"\u4f7f\u7528 SQL \u8868\u8fbe\u5f0f\u3001Context Valuer \u8fdb\u884c CRUD",id:"\u4f7f\u7528-sql-\u8868\u8fbe\u5f0fcontext-valuer-\u8fdb\u884c-crud",level:4},{value:"\u5b57\u6bb5\u6743\u9650",id:"\u5b57\u6bb5\u6743\u9650",level:4},{value:"\u652f\u6301\u591a\u4e2a\u5b57\u6bb5\u8ffd\u8e2a create/update \u65f6\u95f4\uff08 time\u3001unix (\u6beb/\u7eb3) \u79d2\uff09",id:"\u652f\u6301\u591a\u4e2a\u5b57\u6bb5\u8ffd\u8e2a-createupdate-\u65f6\u95f4-timeunix-\u6beb\u7eb3-\u79d2",level:4},{value:"\u591a\u6570\u636e\u5e93\uff0c\u8bfb\u5199\u5206\u79bb",id:"\u591a\u6570\u636e\u5e93\u8bfb\u5199\u5206\u79bb",level:4},{value:"Prometheus",id:"prometheus",level:4},{value:"\u547d\u540d\u7b56\u7565",id:"\u547d\u540d\u7b56\u7565",level:4},{value:"Logger",id:"logger",level:4},{value:"\u4e8b\u52a1\u6a21\u5f0f",id:"\u4e8b\u52a1\u6a21\u5f0f",level:4},{value:"\u6570\u636e\u7c7b\u578b\uff08\u4ee5 JSON \u4e3a\u4f8b\uff09",id:"\u6570\u636e\u7c7b\u578b\u4ee5-json-\u4e3a\u4f8b",level:4},{value:"Smart Select",id:"smart-select",level:4},{value:"\u6279\u91cf\u5173\u8054\u6a21\u5f0f",id:"\u6279\u91cf\u5173\u8054\u6a21\u5f0f",level:4},{value:"\u5220\u9664\u5173\u8054\u8bb0\u5f55",id:"\u5220\u9664\u5173\u8054\u8bb0\u5f55",level:4},{value:"\u7834\u574f\u6027\u53d8\u66f4",id:"\u7834\u574f\u6027\u53d8\u66f4",level:2},{value:"Tag",id:"tag",level:4},{value:"Table Name",id:"table-name",level:4},{value:"\u521b\u5efa\u548c\u5220\u9664\u8868\u683c\u9700\u8981\u4f7f\u7528 Migrator",id:"\u521b\u5efa\u548c\u5220\u9664\u8868\u683c\u9700\u8981\u4f7f\u7528-migrator",level:4},{value:"\u5916\u952e",id:"\u5916\u952e",level:4},{value:"\u65b9\u6cd5\u94fe\u548c\u534f\u7a0b\u5b89\u5168",id:"\u65b9\u6cd5\u94fe\u548c\u534f\u7a0b\u5b89\u5168",level:4},{value:"\u9ed8\u8ba4\u503c",id:"\u9ed8\u8ba4\u503c",level:4},{value:"\u8f6f\u5220\u9664",id:"\u8f6f\u5220\u9664",level:4},{value:"BlockGlobalUpdate",id:"blockglobalupdate",level:4},{value:"ErrRecordNotFound",id:"errrecordnotfound",level:4},{value:"Hook \u65b9\u6cd5",id:"hook-\u65b9\u6cd5",level:4},{value:"Update Hook \u652f\u6301 <code>Changed</code>",id:"update-hook-\u652f\u6301-changed",level:4},{value:"\u63d2\u4ef6",id:"\u63d2\u4ef6",level:4},{value:"\u4f7f\u7528 struct \u66f4\u65b0",id:"\u4f7f\u7528-struct-\u66f4\u65b0",level:4},{value:"\u5173\u8054",id:"\u5173\u8054",level:4},{value:"Join Table",id:"join-table",level:4},{value:"Count",id:"count",level:4},{value:"\u4e8b\u52a1",id:"\u4e8b\u52a1",level:4},{value:"Migrator",id:"migrator",level:4},{value:"Happy Hacking",id:"happy-hacking",level:2}],p={toc:m};function g(e){var n=e.components,t=(0,r.Z)(e,i);return(0,l.kt)("wrapper",(0,a.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"GORM 2.0 \u5b8c\u5168\u4ece\u96f6\u5f00\u59cb\uff0c\u5f15\u5165\u4e86\u4e00\u4e9b\u4e0d\u517c\u5bb9\u7684 API \u53d8\u66f4\u548c\u8bb8\u591a\u6539\u8fdb"),(0,l.kt)("p",null,(0,l.kt)("strong",{parentName:"p"},"\u6458\u8981")),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6027\u80fd\u6539\u8fdb"),(0,l.kt)("li",{parentName:"ul"},"\u4ee3\u7801\u6a21\u5757\u5316"),(0,l.kt)("li",{parentName:"ul"},"Context\uff0c\u6279\u91cf\u63d2\u5165\uff0c\u9884\u7f16\u8bd1\u6a21\u5f0f\uff0cDryRun \u6a21\u5f0f\uff0cJoin \u9884\u52a0\u8f7d\uff0cFind To Map\uff0cCreate From Map\uff0cFindInBatches \u652f\u6301"),(0,l.kt)("li",{parentName:"ul"},"\u652f\u6301\u5d4c\u5957\u4e8b\u52a1\uff0cSavePoint\uff0cRollback To SavePoint"),(0,l.kt)("li",{parentName:"ul"},"SQL \u751f\u6210\u5668\uff0c\u547d\u540d\u53c2\u6570\uff0c\u5206\u7ec4\u6761\u4ef6\uff0cUpsert\uff0c\u9501\uff0c \u652f\u6301 Optimizer/Index/Comment Hint\uff0c\u5b50\u67e5\u8be2\u6539\u8fdb\uff0c\u4f7f\u7528SQL\u8868\u8fbe\u5f0f\u3001Context Valuer \u8fdb\u884c CRUD"),(0,l.kt)("li",{parentName:"ul"},"\u5b8c\u6574\u7684\u81ea\u5f15\u7528\u652f\u6301\uff0c\u8fde\u63a5\u8868\u6539\u8fdb\uff0c\u6279\u91cf\u6570\u636e\u7684\u5173\u8054\u6a21\u5f0f"),(0,l.kt)("li",{parentName:"ul"},"\u5141\u8bb8\u8ddf\u8e2a\u521b\u5efa/\u66f4\u65b0\u65f6\u95f4\u7684\u591a\u4e2a\u5b57\u6bb5\uff0cUNIX (\u6beb\u79d2/\u7eb3\u79d2) \u652f\u6301"),(0,l.kt)("li",{parentName:"ul"},"\u652f\u6301\u5b57\u6bb5\u6743\u9650\uff1a\u53ea\u8bfb\u3001\u53ea\u5199\u3001\u53ea\u521b\u5efa\u3001\u53ea\u66f4\u65b0\u3001\u5ffd\u7565"),(0,l.kt)("li",{parentName:"ul"},"\u65b0\u7684\u63d2\u4ef6\u7cfb\u7edf\uff0c\u4e3a\u591a\u4e2a\u6570\u636e\u5e93\u63d0\u4f9b\u4e86\u5b98\u65b9\u63d2\u4ef6\uff0c\u8bfb\u5199\u5206\u79bb\uff0cprometheus \u96c6\u6210..."),(0,l.kt)("li",{parentName:"ul"},"\u5168\u65b0\u7684 Hook API\uff1a\u5e26\u63d2\u4ef6\u7684\u7edf\u4e00\u63a5\u53e3"),(0,l.kt)("li",{parentName:"ul"},"\u65b0\u8fc1\u79fb\u5668\uff1a\u5141\u8bb8\u4e3a\u5173\u7cfb\u521b\u5efa\u6570\u636e\u5e93\u5916\u952e\uff0c\u66f4\u667a\u80fd\u7684\u81ea\u52a8\u8fc1\u79fb\uff0c\u652f\u6301\u7ea6\u675f\u4ee5\u53ca\u68c0\u67e5\u5668\uff0c\u652f\u6301\u589e\u5f3a\u7d22\u5f15"),(0,l.kt)("li",{parentName:"ul"},"\u5168\u65b0\u7684 Logger\uff1a\u652f\u6301 context\u3001\u6539\u8fdb\u53ef\u6269\u5c55\u6027"),(0,l.kt)("li",{parentName:"ul"},"\u7edf\u4e00\u547d\u540d\u7b56\u7565\uff1a\u8868\u540d\u3001\u5b57\u6bb5\u540d\u3001\u8fde\u63a5\u8868\u540d\u3001\u5916\u952e\u3001\u68c0\u67e5\u5668\u3001\u7d22\u5f15\u540d\u79f0\u89c4\u5219"),(0,l.kt)("li",{parentName:"ul"},"\u66f4\u597d\u7684\u81ea\u5b9a\u4e49\u7c7b\u578b\u652f\u6301\uff08\u4f8b\u5982\uff1a JSON\uff09")),(0,l.kt)("h2",{id:"\u5982\u4f55\u5347\u7ea7"},"\u5982\u4f55\u5347\u7ea7"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"GORM \u7684\u5f00\u53d1\u5df2\u7ecf\u8fc1\u79fb\u81f3 ",(0,l.kt)("a",{parentName:"li",href:"https://github.com/go-gorm"},"github.com/go-gorm"),"\uff0cimport \u8def\u5f84\u4e5f\u4fee\u6539\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"gorm.io/gorm")," \uff0c\u5bf9\u4e8e\u4ee5\u524d\u7684\u9879\u76ee\uff0c\u60a8\u53ef\u4ee5\u7ee7\u7eed\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"github.com/jinzhu/gorm")," \u548c ",(0,l.kt)("a",{parentName:"li",href:"http://v1.gorm.io/zh_CN/"},"GORM V1 \u6587\u6863")),(0,l.kt)("li",{parentName:"ul"},"\u6570\u636e\u5e93\u9a71\u52a8\u88ab\u62c6\u5206\u4e3a\u72ec\u7acb\u7684\u9879\u76ee\uff0c\u4f8b\u5982\uff1a",(0,l.kt)("a",{parentName:"li",href:"https://github.com/go-gorm/sqlite"},"github.com/go-gorm/sqlite"),"\uff0c\u4e14\u5b83\u7684 import \u8def\u5f84\u4e5f\u53d8\u66f4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"gorm.io/driver/sqlite"))),(0,l.kt)("h3",{id:"\u5b89\u88c5"},"\u5b89\u88c5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"go get gorm.io/gorm\n// **\u6ce8\u610f** GORM `v2.0.0` \u53d1\u5e03\u7684 git tag \u662f `v1.20.0`\n")),(0,l.kt)("h3",{id:"\u5feb\u901f\u5f00\u59cb"},"\u5feb\u901f\u5f00\u59cb"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'import (\n  "gorm.io/gorm"\n  "gorm.io/driver/sqlite"\n)\n\nfunc init() {\n  db, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{})\n\n  // \u5927\u90e8\u5206 CRUD API \u90fd\u662f\u517c\u5bb9\u7684\n  db.AutoMigrate(&Product{})\n  db.Create(&user)\n  db.First(&user, 1)\n  db.Model(&user).Update("Age", 18)\n  db.Model(&user).Omit("Role").Updates(map[string]interface{}{"Name": "jinzhu", "Role": "admin"})\n  db.Delete(&user)\n}\n')),(0,l.kt)("h2",{id:"\u4e3b\u8981\u7279\u6027"},"\u4e3b\u8981\u7279\u6027"),(0,l.kt)("p",null,"\u6b64\u53d1\u5e03\u8bf4\u660e\u4ec5\u6db5\u76d6\u4e86 GORM V2 \u4e2d\u7684\u91cd\u5927\u66f4\u6539\uff0c\u4f5c\u4e3a\u5feb\u901f\u53c2\u8003"),(0,l.kt)("h4",{id:"context-\u652f\u6301"},"Context \u652f\u6301"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"\u6570\u636e\u5e93\u64cd\u4f5c\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"li"},"WithContext")," \u65b9\u6cd5\u652f\u6301 ",(0,l.kt)("inlineCode",{parentName:"li"},"Context")),(0,l.kt)("li",{parentName:"ul"},"Logger \u4e5f\u652f\u6301\u7528\u4e8e\u8ffd\u8e2a\u7684 context")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"db.WithContext(ctx).Find(&users)\n")),(0,l.kt)("h4",{id:"\u6279\u91cf\u63d2\u5165"},"\u6279\u91cf\u63d2\u5165"),(0,l.kt)("p",null,"\u8981\u6709\u6548\u5730\u63d2\u5165\u5927\u91cf\u8bb0\u5f55\uff0c\u53ef\u4ee5\u5c06\u4e00\u4e2a slice \u4f20\u9012\u7ed9 ",(0,l.kt)("inlineCode",{parentName:"p"},"Create")," \u65b9\u6cd5\u3002 \u5c06\u5207\u7247\u6570\u636e\u4f20\u9012\u7ed9 Create \u65b9\u6cd5\uff0cGORM \u5c06\u751f\u6210\u4e00\u4e2a\u5355\u4e00\u7684 SQL \u8bed\u53e5\u6765\u63d2\u5165\u6240\u6709\u6570\u636e\uff0c\u5e76\u56de\u586b\u4e3b\u952e\u7684\u503c\uff0c\u94a9\u5b50\u65b9\u6cd5\u4e5f\u4f1a\u88ab\u8c03\u7528\u3002"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'var users = []User{{Name: "jinzhu1"}, {Name: "jinzhu2"}, {Name: "jinzhu3"}}\ndb.Create(&users)\n\nfor _, user := range users {\n  user.ID // 1,2,3\n}\n')),(0,l.kt)("p",null,"\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"CreateInBatches")," \u521b\u5efa\u65f6\uff0c\u4f60\u8fd8\u53ef\u4ee5\u6307\u5b9a\u521b\u5efa\u7684\u6570\u91cf\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'var \u7528\u6237 = []User{name: "jinzhu_1"}, ...., {Name: "jinzhu_10000"}}\n\n// \u6570\u91cf\u4e3a 100\ndb.CreateInBatches(\u7528\u6237, 100)\n')),(0,l.kt)("h4",{id:"\u9884\u7f16\u8bd1\u6a21\u5f0f"},"\u9884\u7f16\u8bd1\u6a21\u5f0f"),(0,l.kt)("p",null,"\u9884\u7f16\u8bd1\u6a21\u5f0f\u4f1a\u9884\u7f16\u8bd1 Sql \u6267\u884c\u8bed\u53e5\uff0c\u4ee5\u52a0\u901f\u540e\u7eed\u6267\u884c\u901f\u5ea6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'// \u5168\u5c40\u6a21\u5f0f\uff0c\u6240\u6709\u7684\u64cd\u4f5c\u90fd\u4f1a\u521b\u5efa\u5e76\u7f13\u5b58\u9884\u7f16\u8bd1\u8bed\u53e5\uff0c\u4ee5\u52a0\u901f\u540e\u7eed\u6267\u884c\u901f\u5ea6\ndb, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{PrepareStmt: true})\n\n// \u4f1a\u8bdd\u6a21\u5f0f\uff0c\u5f53\u524d\u4f1a\u8bdd\u4e2d\u7684\u64cd\u4f5c\u4f1a\u521b\u5efa\u5e76\u7f13\u5b58\u9884\u7f16\u8bd1\u8bed\u53e5\ntx := db.Session(&Session{PrepareStmt: true})\ntx.First(&user, 1)\ntx.Find(&users)\ntx.Model(&user).Update("Age", 18)\n')),(0,l.kt)("h4",{id:"dryrun-\u6a21\u5f0f"},"DryRun \u6a21\u5f0f"),(0,l.kt)("p",null,"DryRun \u6a21\u5f0f\u4f1a\u751f\u6210\u4f46\u4e0d\u6267\u884c SQL\uff0c\u53ef\u4ee5\u7528\u4e8e\u68c0\u67e5\u3001\u6d4b\u8bd5\u751f\u6210\u7684 SQL"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"stmt := db.Session(&Session{DryRun: true}).Find(&user, 1).Statement\nstmt.SQL.String() //=> SELECT * FROM `users` WHERE `id` = $1 // PostgreSQL\nstmt.SQL.String() //=> SELECT * FROM `users` WHERE `id` = ?  // MySQL\nstmt.Vars         //=> []interface{}{1}\n")),(0,l.kt)("h4",{id:"joins-\u9884\u52a0\u8f7d"},"Joins \u9884\u52a0\u8f7d"),(0,l.kt)("p",null,"\u4f7f\u7528 INNER JOIN \u9884\u52a0\u8f7d\u5173\u8054\uff0c\u5e76\u5904\u7406 null \u6570\u636e\u907f\u514d scan \u5931\u8d25"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Joins("Company").Joins("Manager").Joins("Account").Find(&users, "users.id IN ?", []int{1,2})\n')),(0,l.kt)("h4",{id:"find-to-map"},"Find To Map"),(0,l.kt)("p",null,"Scan \u7ed3\u679c\u5230 ",(0,l.kt)("inlineCode",{parentName:"p"},"map[string]interface{}")," \u6216 ",(0,l.kt)("inlineCode",{parentName:"p"},"[]map[string]interface{}")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'var result map[string]interface{}\ndb.Model(&User{}).First(&result, "id = ?", 1)\n')),(0,l.kt)("h4",{id:"create-from-map"},"Create From Map"),(0,l.kt)("p",null,"\u6839\u636e ",(0,l.kt)("inlineCode",{parentName:"p"},"map[string]interface{}")," \u6216 ",(0,l.kt)("inlineCode",{parentName:"p"},"[]map[string]interface{}")," Create"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Model(&User{}).Create(map[string]interface{}{"Name": "jinzhu", "Age": 18})\n\ndatas := []map[string]interface{}{\n  {"Name": "jinzhu_1", "Age": 19},\n  {"name": "jinzhu_2", "Age": 20},\n}\n\ndb.Model(&User{}).Create(datas)\n')),(0,l.kt)("h4",{id:"findinbatches"},"FindInBatches"),(0,l.kt)("p",null,"\u7528\u4e8e\u6279\u91cf\u67e5\u8be2\u5e76\u5904\u7406\u8bb0\u5f55"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'result := db.Where("age>?", 13).FindInBatches(&results, 100, func(tx *gorm.DB, batch int) error {\n  // \u6279\u91cf\u5904\u7406\n  return nil\n})\n')),(0,l.kt)("h4",{id:"\u5d4c\u5957\u4e8b\u52a1"},"\u5d4c\u5957\u4e8b\u52a1"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Transaction(func(tx *gorm.DB) error {\n  tx.Create(&user1)\n\n  tx.Transaction(func(tx2 *gorm.DB) error {\n    tx.Create(&user2)\n    return errors.New("rollback user2") // rollback user2\n  })\n\n  tx.Transaction(func(tx2 *gorm.DB) error {\n    tx.Create(&user3)\n    return nil\n  })\n\n  return nil // commit user1 and user3\n})\n')),(0,l.kt)("h4",{id:"savepointrollbackto"},"SavePoint\uff0cRollbackTo"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'tx := db.Begin()\ntx.Create(&user1)\n\ntx.SavePoint("sp1")\ntx.Create(&user2)\ntx.RollbackTo("sp1") // rollback user2\n\ntx.Commit() // commit user1\n')),(0,l.kt)("h4",{id:"\u547d\u540d\u53c2\u6570"},"\u547d\u540d\u53c2\u6570"),(0,l.kt)("p",null,"GORM \u652f\u6301\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"sql.NamedArg"),"\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"map[string]interface{}")," \u4f5c\u4e3a\u547d\u540d\u53c2\u6570"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Where("name1 = @name OR name2 = @name", sql.Named("name", "jinzhu")).Find(&user)\n// SELECT * FROM `users` WHERE name1 = "jinzhu" OR name2 = "jinzhu"\n\ndb.Where("name1 = @name OR name2 = @name", map[string]interface{}{"name": "jinzhu2"}).First(&result3)\n// SELECT * FROM `users` WHERE name1 = "jinzhu2" OR name2 = "jinzhu2" ORDER BY `users`.`id` LIMIT 1\n\ndb.Raw(\n  "SELECT * FROM users WHERE name1 = @name OR name2 = @name2 OR name3 = @name",\n  sql.Named("name", "jinzhu1"), sql.Named("name2", "jinzhu2"),\n).Find(&user)\n// SELECT * FROM users WHERE name1 = "jinzhu1" OR name2 = "jinzhu2" OR name3 = "jinzhu1"\n\ndb.Exec(\n  "UPDATE users SET name1 = @name, name2 = @name2, name3 = @name",\n  map[string]interface{}{"name": "jinzhu", "name2": "jinzhu2"},\n)\n// UPDATE users SET name1 = "jinzhu", name2 = "jinzhu2", name3 = "jinzhu"\n')),(0,l.kt)("h4",{id:"\u5206\u7ec4\u6761\u4ef6"},"\u5206\u7ec4\u6761\u4ef6"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Where(\n  db.Where("pizza = ?", "pepperoni").Where(db.Where("size = ?", "small").Or("size = ?", "medium")),\n).Or(\n  db.Where("pizza = ?", "hawaiian").Where("size = ?", "xlarge"),\n).Find(&pizzas)\n\n// SELECT * FROM pizzas WHERE (pizza = \'pepperoni\' AND (size = \'small\' OR size = \'medium\')) OR (pizza = \'hawaiian\' AND size = \'xlarge\')\n')),(0,l.kt)("h4",{id:"\u5b50\u67e5\u8be2"},"\u5b50\u67e5\u8be2"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'// Where \u5b50\u67e5\u8be2\ndb.Where("amount > (?)", db.Table("orders").Select("AVG(amount)")).Find(&orders)\n\n// From \u5b50\u67e5\u8be2\ndb.Table("(?) as u", db.Model(&User{}).Select("name", "age")).Where("age = ?", 18}).Find(&User{})\n// SELECT * FROM (SELECT `name`,`age` FROM `users`) as u WHERE age = 18\n\n// Update \u5b50\u67e5\u8be2\ndb.Model(&user).Update(\n  "price", db.Model(&Company{}).Select("name").Where("companies.id = users.company_id"),\n)\n')),(0,l.kt)("h4",{id:"upsert"},"Upsert"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"clause.OnConflict")," \u4e3a\u4e0d\u540c\u7684\u6570\u636e\u5e93\uff08SQLite\uff0cMySQL\uff0cPostgreSQL\uff0cSQL Server\uff09\u63d0\u4f9b\u4e86\u517c\u5bb9\u7684 Upsert \u652f\u6301"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'import "gorm.io/gorm/clause"\n\ndb.Clauses(clause.OnConflict{DoNothing: true}).Create(&users)\n\ndb.Clauses(clause.OnConflict{\n  Columns:   []clause.Column{{Name: "id"}},\n  DoUpdates: clause.Assignments(map[string]interface{}{"name": "jinzhu", "age": 18}),\n}).Create(&users)\n// MERGE INTO "users" USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET ***; SQL Server\n// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE name="jinzhu", age=18; MySQL\n\ndb.Clauses(clause.OnConflict{\n  Columns:   []clause.Column{{Name: "id"}},\n  DoUpdates: clause.AssignmentColumns([]string{"name", "age"}),\n}).Create(&users)\n// MERGE INTO "users" USING *** WHEN NOT MATCHED THEN INSERT *** WHEN MATCHED THEN UPDATE SET "name"="excluded"."name"; SQL Server\n// INSERT INTO "users" *** ON CONFLICT ("id") DO UPDATE SET "name"="excluded"."name", "age"="excluded"."age"; PostgreSQL\n// INSERT INTO `users` *** ON DUPLICATE KEY UPDATE `name`=VALUES(name),`age=VALUES(age); MySQL\n')),(0,l.kt)("h4",{id:"locking"},"Locking"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Clauses(clause.Locking{Strength: "UPDATE"}).Find(&users)\n// SELECT * FROM `users` FOR UPDATE\n\ndb.Clauses(clause.Locking{\n  Strength: "SHARE",\n  Table: clause.Table{Name: clause.CurrentTable},\n}).Find(&users)\n// SELECT * FROM `users` FOR SHARE OF `users`\n')),(0,l.kt)("h4",{id:"optimizerindexcomment-hint"},"Optimizer/Index/Comment Hint"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'import "gorm.io/hints"\n\n// Optimizer Hints\ndb.Clauses(hints.New("hint")).Find(&User{})\n// SELECT * /*+ hint */ FROM `users`\n\n// Index Hints\ndb.Clauses(hints.UseIndex("idx_user_name")).Find(&User{})\n// SELECT * FROM `users` USE INDEX (`idx_user_name`)\n\n// Comment Hints\ndb.Clauses(hints.Comment("select", "master")).Find(&User{})\n// SELECT /*master*/ * FROM `users`;\n')),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"hints.html"},"Hint")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"\u4f7f\u7528-sql-\u8868\u8fbe\u5f0fcontext-valuer-\u8fdb\u884c-crud"},"\u4f7f\u7528 SQL \u8868\u8fbe\u5f0f\u3001Context Valuer \u8fdb\u884c CRUD"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'type Location struct {\n    X, Y int\n}\n\nfunc (loc Location) GormDataType() string {\n  return "geometry"\n}\n\nfunc (loc Location) GormValue(ctx context.Context, db *gorm.DB) clause.Expr {\n  return clause.Expr{\n    SQL:  "ST_PointFromText(?)",\n    Vars: []interface{}{fmt.Sprintf("POINT(%d %d)", loc.X, loc.Y)},\n  }\n}\n\ndb.Create(&User{\n  Name:     "jinzhu",\n  Location: Location{X: 100, Y: 100},\n})\n// INSERT INTO `users` (`name`,`point`) VALUES ("jinzhu",ST_PointFromText("POINT(100 100)"))\n\ndb.Model(&User{ID: 1}).Updates(User{\n  Name:  "jinzhu",\n  Point: Point{X: 100, Y: 100},\n})\n// UPDATE `user_with_points` SET `name`="jinzhu",`point`=ST_PointFromText("POINT(100 100)") WHERE `id` = 1\n')),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"data_types.html#gorm_valuer_interface"},"\u81ea\u5b9a\u4e49\u6570\u636e\u7c7b\u578b")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"\u5b57\u6bb5\u6743\u9650"},"\u5b57\u6bb5\u6743\u9650"),(0,l.kt)("p",null,"\u652f\u6301\u5b57\u6bb5\u6743\u9650\uff0c\u6743\u9650\u7ea7\u522b\u6709\uff1a\u53ea\u8bfb\u3001\u53ea\u5199\u3001\u53ea\u521b\u5efa\u3001\u53ea\u66f4\u65b0\u3001\u5ffd\u7565"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  Name string `gorm:"<-:create"` // \u5141\u8bb8\u8bfb\u548c\u521b\u5efa\n  Name string `gorm:"<-:update"` // \u5141\u8bb8\u8bfb\u548c\u66f4\u65b0\n  Name string `gorm:"<-"`        // \u5141\u8bb8\u8bfb\u548c\u5199\uff08\u521b\u5efa\u548c\u66f4\u65b0\uff09\n  Name string `gorm:"->:false;<-:create"` // \u53ea\u521b\u5efa\n  Name string `gorm:"->"` // \u53ea\u8bfb\n  Name string `gorm:"-"`  // \u5ffd\u7565\n}\n')),(0,l.kt)("h4",{id:"\u652f\u6301\u591a\u4e2a\u5b57\u6bb5\u8ffd\u8e2a-createupdate-\u65f6\u95f4-timeunix-\u6beb\u7eb3-\u79d2"},"\u652f\u6301\u591a\u4e2a\u5b57\u6bb5\u8ffd\u8e2a create/update \u65f6\u95f4\uff08 time\u3001unix (\u6beb/\u7eb3) \u79d2\uff09"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'type User struct {\n  CreatedAt time.Time // \u5728\u521b\u5efa\u65f6\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u503c\u4e3a\u96f6\u503c\uff0c\u5219\u4f7f\u7528\u5f53\u524d\u65f6\u95f4\u586b\u5145\n  UpdatedAt int       // \u5728\u521b\u5efa\u65f6\u8be5\u5b57\u6bb5\u503c\u4e3a\u96f6\u503c\u6216\u8005\u5728\u66f4\u65b0\u65f6\uff0c\u4f7f\u7528\u5f53\u524d\u65f6\u95f4\u6233\u7684\u79d2\u6570\u586b\u5145\n  Updated   int64 `gorm:"autoUpdateTime:nano"` // \u4f7f\u7528\u65f6\u95f4\u6233\u7684\u7eb3\u79d2\u6570\u586b\u5145\u66f4\u65b0\u65f6\u95f4\n  Updated2   int64 `gorm:"autoUpdateTime:milli"` // \u4f7f\u7528\u65f6\u95f4\u6233\u7684\u6beb\u79d2\u6570\u586b\u5145\u66f4\u65b0\u65f6\u95f4\n  Created   int64 `gorm:"autoCreateTime"`      // \u4f7f\u7528\u65f6\u95f4\u6233\u7684\u79d2\u6570\u586b\u5145\u521b\u5efa\u65f6\u95f4\n}\n')),(0,l.kt)("h4",{id:"\u591a\u6570\u636e\u5e93\u8bfb\u5199\u5206\u79bb"},"\u591a\u6570\u636e\u5e93\uff0c\u8bfb\u5199\u5206\u79bb"),(0,l.kt)("p",null,"GORM \u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"p"},"DB Resolver")," \u63d2\u4ef6\u63d0\u4f9b\u4e86\u591a\u6570\u636e\u5e93\uff0c\u8bfb\u5199\u5206\u79bb\u652f\u6301\u3002\u8be5\u63d2\u4ef6\u8fd8\u652f\u6301\u57fa\u4e8e\u5f53\u524d struct \u548c\u8868\u81ea\u52a8\u5207\u6362\u6570\u636e\u5e93\u548c\u8868\uff0c\u81ea\u5b9a\u4e49\u8d1f\u8f7d\u5747\u8861\u903b\u8f91\u7684\u591a source\u3001replica"),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"dbresolver.html"},"Database Resolver")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"prometheus"},"Prometheus"),(0,l.kt)("p",null,"GORM \u63d0\u4f9b\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"Prometheus")," \u63d2\u4ef6\u6765\u6536\u96c6 ",(0,l.kt)("inlineCode",{parentName:"p"},"DBStats")," \u548c\u7528\u6237\u81ea\u5b9a\u4e49\u6307\u6807"),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"prometheus.html"},"Prometheus")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"\u547d\u540d\u7b56\u7565"},"\u547d\u540d\u7b56\u7565"),(0,l.kt)("p",null,"GORM \u5141\u8bb8\u7528\u6237\u901a\u8fc7\u8986\u76d6\u9ed8\u8ba4\u7684",(0,l.kt)("inlineCode",{parentName:"p"},"\u547d\u540d\u7b56\u7565"),"\u66f4\u6539\u9ed8\u8ba4\u7684\u547d\u540d\u7ea6\u5b9a\uff0c\u547d\u540d\u7b56\u7565\u88ab\u7528\u4e8e\u6784\u5efa\uff1a ",(0,l.kt)("inlineCode",{parentName:"p"},"TableName"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"ColumnName"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"JoinTableName"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"RelationshipFKName"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"CheckerName"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"IndexName"),"\u3002\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"gorm_config.html"},"GORM \u914d\u7f6e")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{\n  NamingStrategy: schema.NamingStrategy{TablePrefix: "t_", SingularTable: true},\n})\n')),(0,l.kt)("h4",{id:"logger"},"Logger"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Context \u652f\u6301"),(0,l.kt)("li",{parentName:"ul"},"\u81ea\u5b9a\u4e49\u6216\u5173\u95ed\u65e5\u5fd7\u7684\u989c\u8272"),(0,l.kt)("li",{parentName:"ul"},"\u6162 SQL \u65e5\u5fd7\uff0c\u6162 SQL \u9ed8\u8ba4\u9608\u503c\u662f 200ms"),(0,l.kt)("li",{parentName:"ul"},"\u4f18\u5316\u4e86 SQL \u65e5\u5fd7\u683c\u5f0f\uff0c\u53ef\u4ee5\u66f4\u65b9\u4fbf\u7684\u590d\u5236\u5230\u6570\u636e\u5e93\u63a7\u5236\u53f0\u4e2d\u6267\u884c")),(0,l.kt)("h4",{id:"\u4e8b\u52a1\u6a21\u5f0f"},"\u4e8b\u52a1\u6a21\u5f0f"),(0,l.kt)("p",null,"\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cGORM \u6240\u6709\u7684\u5199\u64cd\u4f5c\u90fd\u4f1a\u5728\u4e8b\u52a1\u4e2d\u8fd0\u884c\uff0c\u4ee5\u786e\u4fdd\u6570\u636e\u7684\u4e00\u81f4\u6027\u3002 \u5982\u679c\u4e0d\u9700\u8981\uff0c\u60a8\u53ef\u4ee5\u5728\u521d\u59cb\u5316\u65f6\u7981\u7528\u5b83\u6765\u52a0\u901f\u5199\u5165\u64cd\u4f5c"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db, err := gorm.Open(sqlite.Open("gorm.db"), &gorm.Config{\n  SkipDefaultTransaction: true,\n})\n')),(0,l.kt)("h4",{id:"\u6570\u636e\u7c7b\u578b\u4ee5-json-\u4e3a\u4f8b"},"\u6570\u636e\u7c7b\u578b\uff08\u4ee5 JSON \u4e3a\u4f8b\uff09"),(0,l.kt)("p",null,"GORM \u4f18\u5316\u4e86\u5bf9\u81ea\u5b9a\u4e49\u7c7b\u578b\u7684\u652f\u6301\uff0c\u73b0\u5728\u60a8\u53ef\u4ee5\u5b9a\u4e49\u4e00\u4e2a struct \u6765\u652f\u6301\u6240\u6709\u7c7b\u578b\u7684\u6570\u636e\u5e93"),(0,l.kt)("p",null,"\u4e0b\u9762\u4ee5 JSON \u4e3a\u4f8b\uff08\u652f\u6301 SQLite\u3001MySQL\u3001Postgres\u3002\u53c2\u8003\u81ea\uff1a",(0,l.kt)("a",{parentName:"p",href:"https://github.com/go-gorm/datatypes/blob/master/json.go"},"https://github.com/go-gorm/datatypes/blob/master/json.go")," \uff09"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'import "gorm.io/datatypes"\n\ntype User struct {\n  gorm.Model\n  Name       string\n  Attributes datatypes.JSON\n}\n\ndb.Create(&User{\n  Name:       "jinzhu",\n  Attributes: datatypes.JSON([]byte(`{"name": "jinzhu", "age": 18, "tags": ["tag1", "tag2"], "orgs": {"orga": "orga"}}`)),\n}\n\n// \u67e5\u8be2 attributes \u4e2d\u6709 role \u5b57\u6bb5\u7684 user\ndb.First(&user, datatypes.JSONQuery("attributes").HasKey("role"))\n// \u67e5\u8be2 attributes \u4e2d\u6709 orgs->orga \u5b57\u6bb5\u7684 user\ndb.First(&user, datatypes.JSONQuery("attributes").HasKey("orgs", "orga"))\n')),(0,l.kt)("h4",{id:"smart-select"},"Smart Select"),(0,l.kt)("p",null,"GORM \u53ef\u4ee5\u901a\u8fc7 ",(0,l.kt)("a",{parentName:"p",href:"query.html"},(0,l.kt)("inlineCode",{parentName:"a"},"Select"))," \u9009\u62e9\u6307\u5b9a\u7684\u5b57\u6bb5\uff0c\u800c\u5728 V2 \u4e2d\uff0c\u901a\u8fc7\u4e00\u4e2a\u8f83\u5c0f\u7684 struct\uff0c\u53ef\u4ee5\u4f7f\u7528 GORM \u63d0\u4f9b\u7684 smart select \u6a21\u5f0f"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type User struct {\n  ID     uint\n  Name   string\n  Age    int\n  Gender string\n  // \u5047\u8bbe\u540e\u9762\u8fd8\u6709\u51e0\u767e\u4e2a\u5b57\u6bb5...\n}\n\ntype APIUser struct {\n  ID   uint\n  Name string\n}\n\n// \u67e5\u8be2\u65f6\u4f1a\u81ea\u52a8\u9009\u62e9 `id`, `name` \u5b57\u6bb5\ndb.Model(&User{}).Limit(10).Find(&APIUser{})\n// SELECT `id`, `name` FROM `users` LIMIT 10\n")),(0,l.kt)("h4",{id:"\u6279\u91cf\u5173\u8054\u6a21\u5f0f"},"\u6279\u91cf\u5173\u8054\u6a21\u5f0f"),(0,l.kt)("p",null,"\u5173\u8054\u6a21\u5f0f\u4e5f\u652f\u6301\u6279\u91cf\u5904\u7406\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'// \u67e5\u8be2\u6240\u6709\u7528\u6237\u7684\u6240\u6709\u89d2\u8272\ndb.Model(&users).Association("Role").Find(&roles)\n\n// \u5c06 userA \u4ece\u6240\u6709\u7684 Team \u4e2d\u79fb\u9664\ndb.Model(&users).Association("Team").Delete(&userA)\n\n// \u83b7\u53d6\u6240\u6709 Team \u6210\u5458\u7684\u4e0d\u91cd\u590d\u8ba1\u6570\ndb.Model(&users).Association("Team").Count()\n\n// \u5bf9\u4e8e `Append`\u3001`Replace` \u7684\u6279\u91cf\u5904\u7406\uff0c\u53c2\u6570\u4e0e\u6570\u636e\u7684\u957f\u5ea6\u5fc5\u987b\u76f8\u7b49\uff0c\u5426\u5219\u4f1a\u8fd4\u56de\u9519\u8bef\nvar users = []User{user1, user2, user3}\n// \u4f8b\u5982\uff1a\u6211\u4eec\u6709 3 \u4e2a user\uff0c\u5c06 userA \u6dfb\u52a0\u5230 user1 \u7684 Team\uff0c\u5c06 userB \u6dfb\u52a0\u5230 user2 \u7684 Team\uff0c\u5c06 userA\u3001userB\u3001userC \u6dfb\u52a0\u5230 user3 \u7684 Team\ndb.Model(&users).Association("Team").Append(&userA, &userB, &[]User{userA, userB, userC})\n// \u5c06 user1 \u7684 Team \u91cd\u7f6e\u4e3a userA\uff0c\u5c06 user2\u7684 team \u91cd\u7f6e\u4e3a userB\uff0c\u5c06 user3 \u7684 team \u91cd\u7f6e\u4e3a userA\u3001userB \u548c userC\ndb.Model(&users).Association("Team").Replace(&userA, &userB, &[]User{userA, userB, userC})\n')),(0,l.kt)("h4",{id:"\u5220\u9664\u5173\u8054\u8bb0\u5f55"},"\u5220\u9664\u5173\u8054\u8bb0\u5f55"),(0,l.kt)("p",null,"\u4f60\u53ef\u4ee5\u5728\u5220\u9664\u8bb0\u5f55\u65f6\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"p"},"Select")," \u6765\u5220\u9664\u5177\u6709 has one\u3001has many\u3001many2many \u5173\u7cfb\u7684\u8bb0\u5f55\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'// \u5220\u9664 user \u65f6\uff0c\u4e5f\u5220\u9664 user \u7684 account\ndb.Select("Account").Delete(&user)\n\n// \u5220\u9664 user \u65f6\uff0c\u4e5f\u5220\u9664 user \u7684 Orders\u3001CreditCards \u8bb0\u5f55\ndb.Select("Orders", "CreditCards").Delete(&user)\n\n// \u5220\u9664 user \u65f6\uff0c\u4e5f\u5220\u9664\u7528\u6237\u6240\u6709 has one/many\u3001many2many \u8bb0\u5f55\ndb.Select(clause.Associations).Delete(&user)\n\n// \u5220\u9664 users \u65f6\uff0c\u4e5f\u5220\u9664 user \u4eec\u7684 account\ndb.Select("Account").Delete(&users)\n')),(0,l.kt)("h2",{id:"\u7834\u574f\u6027\u53d8\u66f4"},"\u7834\u574f\u6027\u53d8\u66f4"),(0,l.kt)("p",null,"\u6211\u4eec\u5c3d\u53ef\u80fd\u7684\u5217\u51fa\u7834\u574f\u6027\u3001\u65e0\u6cd5\u88ab\u7f16\u8bd1\u5668\u6355\u83b7\u7684\u53d8\u66f4\u3002\u5982\u679c\u60a8\u53d1\u73b0\u4e86\u4efb\u4f55\u9057\u6f0f\u7684\u5185\u5bb9\uff0c\u6b22\u8fce\u5728 ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/go-gorm/gorm.io"},"\u8fd9\u91cc")," \u521b\u5efa issue \u6216 pr"),(0,l.kt)("h4",{id:"tag"},"Tag"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"GORM V2 \u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"li"},"camelCase")," \u98ce\u683c\u7684 tag \u540d\u3002",(0,l.kt)("inlineCode",{parentName:"li"},"snake_case")," \u98ce\u683c\u7684 tag \u5df2\u7ecf\u5931\u6548\uff0c\u4f8b\u5982\uff1a ",(0,l.kt)("inlineCode",{parentName:"li"},"auto_increment"),"\u3001",(0,l.kt)("inlineCode",{parentName:"li"},"unique_index"),"\u3001",(0,l.kt)("inlineCode",{parentName:"li"},"polymorphic_value"),"\u3001",(0,l.kt)("inlineCode",{parentName:"li"},"embeded_prefix"),"\uff0c\u67e5\u770b ",(0,l.kt)("a",{parentName:"li",href:"models.html#tags"},"Model Tag")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("li",{parentName:"ul"},"\u7528\u4e8e\u6307\u5b9a\u5916\u952e\u7684 tag \u5df2\u53d8\u66f4\u4e3a ",(0,l.kt)("inlineCode",{parentName:"li"},"foreignKey"),"\uff0c",(0,l.kt)("inlineCode",{parentName:"li"},"references"),"\uff0c\u67e5\u770b ",(0,l.kt)("a",{parentName:"li",href:"associations.html#tags"},"Association Tag")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("li",{parentName:"ul"},"\u4e0d\u652f\u6301 ",(0,l.kt)("inlineCode",{parentName:"li"},"sql")," \u6807\u7b7e")),(0,l.kt)("h4",{id:"table-name"},"Table Name"),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"TableName")," ",(0,l.kt)("em",{parentName:"p"},"\u4e0d\u518d")," \u5141\u8bb8\u52a8\u6001\u8868\u540d\uff0c \u56e0\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"TableName")," \u7684\u8fd4\u56de\u503c\u4f1a\u88ab\u7f13\u5b58\u4e0b\u6765"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (User) TableName() string {\n  return "t_user"\n}\n')),(0,l.kt)("p",null,"\u52a8\u6001\u8868\u540d\u8bf7\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"Scopes"),"\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func UserTable(u *User) func(*gorm.DB) *gorm.DB {\n  return func(db *gorm.DB) *gorm.DB {\n    return db.Table("user_" + u.Role)\n  }\n}\n\ndb.Scopes(UserTable(&user)).Create(&user)\n')),(0,l.kt)("h4",{id:"\u521b\u5efa\u548c\u5220\u9664\u8868\u683c\u9700\u8981\u4f7f\u7528-migrator"},"\u521b\u5efa\u548c\u5220\u9664\u8868\u683c\u9700\u8981\u4f7f\u7528 Migrator"),(0,l.kt)("p",null,"\u4ee5\u524d\u521b\u5efa\u548c\u5220\u9664\u8868\u683c\u662f\u8fd9\u6837\u7684\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"db.CreateTable(&MyTable{})\ndb.DropTable(&MyTable{})\n")),(0,l.kt)("p",null,"\u73b0\u5728\u60a8\u9700\u8981\u8fd9\u6837\u505a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"db.Migrator().CreateTable(&MyTable{})\ndb.Migrator().DropTable(&MyTable{})\n")),(0,l.kt)("h4",{id:"\u5916\u952e"},"\u5916\u952e"),(0,l.kt)("p",null,"\u4ee5\u524d\u60a8\u53ef\u4ee5\u8fd9\u6837\u6dfb\u52a0\u5916\u952e\u7ea6\u675f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Model(&MyTable{}).AddForeignKey("profile_id", "profiles(id)", "NO ACTION", "NO ACTION")\n')),(0,l.kt)("p",null,"\u73b0\u5728\u60a8\u9700\u8981\u8fd9\u6837\u6dfb\u52a0\u7ea6\u675f\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Migrator().CreateConstraint(&Users{}), "Profiles")\ndb.Migrator().CreateConstraint(&Users{}), "fk_users_profiles")\n')),(0,l.kt)("p",null,"\u5bf9\u4e8epostgres\uff0cGORM \u4f1a\u5c06\u5176\u7ffb\u8bd1\u4e3a\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE `Profiles` ADD CONSTRAINT `fk_users_profiles` FORIEGN KEY (`useres_id`) REFRENCES `users`(`id`))\n")),(0,l.kt)("h4",{id:"\u65b9\u6cd5\u94fe\u548c\u534f\u7a0b\u5b89\u5168"},"\u65b9\u6cd5\u94fe\u548c\u534f\u7a0b\u5b89\u5168"),(0,l.kt)("p",null,"\u4e3a\u4e86\u51cf\u5c11 GC \u5206\u914d\uff0c\u5728\u4f7f\u7528\u94fe\u5f0f\u8c03\u7528\u65f6\uff0cGORM V2 \u4f1a\u5171\u4eab ",(0,l.kt)("inlineCode",{parentName:"p"},"Statement"),"\uff0c\u4e14\u53ea\u5728\u521d\u59cb\u5316 ",(0,l.kt)("inlineCode",{parentName:"p"},"*gorm.DB")," \u6216\u8c03\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"New Session Method")," \u540e\u521b\u5efa\u65b0\u7684 ",(0,l.kt)("inlineCode",{parentName:"p"},"Statement"),"\u3002\u60f3\u8981\u590d\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"*gorm.DB"),"\uff0c\u60a8\u9700\u8981\u786e\u4fdd\u8be5\u5b83\u521a\u8c03\u7528\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"p"},"New Session Method"),"\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db, err := gorm.Open(sqlite.Open("test.db"), &gorm.Config{})\n\n// \u5bf9\u4e8e\u521a\u521d\u59cb\u5316\u7684 *gorm.DB \u662f\u5b89\u5168\u7684\nfor i := 0; i < 100; i++ {\n  go db.Where(...).First(&user)\n}\n\ntx := db.Where("name = ?", "jinzhu")\n// \u4e0d\u5b89\u5168\uff0c\u56e0\u4e3a\u590d\u7528\u4e86 Statement\nfor i := 0; i < 100; i++ {\n  go tx.Where(...).First(&user)\n}\n\nctxDB := db.WithContext(ctx)\n// Safe after a `New Session Method`\nfor i := 0; i < 100; i++ {\n  go ctxDB.Where(...).First(&user)\n}\n\nctxDB := db.Where("name = ?", "jinzhu").WithContext(ctx)\n// \u8c03\u7528 `New Session Method` \u540e\u662f\u5b89\u5168\u7684\nfor i := 0; i < 100; i++ {\n  go ctxDB.Where(...).First(&user) // `name = \'jinzhu\'` \u4f1a\u5e94\u7528\u81f3\u8be5\u67e5\u8be2\n}\n\ntx := db.Where("name = ?", "jinzhu").Session(&gorm.Session{})\n// \u8c03\u7528 `New Session Method` \u540e\u662f\u5b89\u5168\u7684\nfor i := 0; i < 100; i++ {\n  go tx.Where(...).First(&user) // `name = \'jinzhu\'` \u4f1a\u5e94\u7528\u81f3\u8be5\u67e5\u8be2\n}\n')),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"method_chaining.html"},"\u65b9\u6cd5\u94fe")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"\u9ed8\u8ba4\u503c"},"\u9ed8\u8ba4\u503c"),(0,l.kt)("p",null,"\u521b\u5efa\u8bb0\u5f55\u540e\uff0cGORM V2 \u4e0d\u4f1a\u81ea\u52a8\u52a0\u8f7d\u7531\u6570\u636e\u5e93\u751f\u6210\u7684\u9ed8\u8ba4\u503c\uff0c\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"create.html#default_values"},"\u9ed8\u8ba4\u503c")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"\u8f6f\u5220\u9664"},"\u8f6f\u5220\u9664"),(0,l.kt)("p",null,"\u5728 GORM V1 \u4e2d\uff0c\u5982\u679c model \u4e2d\u6709\u4e00\u4e2a\u540d\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"DeletedAt")," \u7684\u5b57\u6bb5\u5219\u81ea\u52a8\u5f00\u542f\u8f6f\u5220\u9664\u3002\u5728V2\uff0c\u60a8\u9700\u8981\u5728\u60f3\u542f\u7528\u8f6f\u5220\u9664\u7684 model \u4e2d\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"gorm.DeletedAt"),"\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"type User struct {\n  ID        uint\n  DeletedAt gorm.DeletedAt\n}\n\ntype User struct {\n  ID      uint\n  // \u5b57\u6bb5\u540d\u65e0\u8981\u6c42\n  Deleted gorm.DeletedAt\n}\n")),(0,l.kt)("p",null,"{% note warn %}\n",(0,l.kt)("strong",{parentName:"p"},"\u6ce8\u610f\uff1a")," ",(0,l.kt)("inlineCode",{parentName:"p"},"gorm.Model")," \u4f7f\u7528\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"gorm.DeletedAt"),"\uff0c\u5982\u679c\u4f60\u5df2\u7ecf\u5d4c\u5165\u4e86\u5b83\uff0c\u5219\u4e0d\u9700\u8981\u505a\u4ec0\u4e48\u4fee\u6539\n{% endnote %}"),(0,l.kt)("h4",{id:"blockglobalupdate"},"BlockGlobalUpdate"),(0,l.kt)("p",null,"GORM V2 \u9ed8\u8ba4\u542f\u7528\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"BlockGlobalUpdate")," \u6a21\u5f0f\u3002\u60f3\u8981\u89e6\u53d1\u5168\u5c40 update/delete\uff0c\u4f60\u5fc5\u987b\u4f7f\u7528\u4e00\u4e9b\u6761\u4ef6\u3001\u539f\u751f SQL \u6216\u8005\u542f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"AllowGlobalUpdate")," \u6a21\u5f0f\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Where("1 = 1").Delete(&User{})\n\ndb.Raw("delete from users")\n\ndb.Session(&gorm.Session{AllowGlobalUpdate: true}).Delete(&User{})\n')),(0,l.kt)("h4",{id:"errrecordnotfound"},"ErrRecordNotFound"),(0,l.kt)("p",null,"GORM V2 \u53ea\u6709\u5728\u4f60\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"First"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"Last"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"Take")," \u8fd9\u4e9b\u9884\u671f\u4f1a\u8fd4\u56de\u7ed3\u679c\u7684\u65b9\u6cd5\u67e5\u8be2\u8bb0\u5f55\u65f6\uff0c\u624d\u4f1a\u8fd4\u56de ",(0,l.kt)("inlineCode",{parentName:"p"},"ErrRecordNotFound"),"\uff0c\u6211\u4eec\u8fd8\u79fb\u9664\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"RecordNotFound")," \u65b9\u6cd5\uff0c\u8bf7\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"errors.Is")," \u6765\u68c0\u67e5\u9519\u8bef\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"err := db.First(&user).Error\nerrors.Is(err, gorm.ErrRecordNotFound)\n")),(0,l.kt)("h4",{id:"hook-\u65b9\u6cd5"},"Hook \u65b9\u6cd5"),(0,l.kt)("p",null,"\u5728 V2 \u4e2d\uff0cBefore/After Create/Update/Save/Find/Delete \u5fc5\u987b\u5b9a\u4e49\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"func(tx *gorm.DB) error")," \u7c7b\u578b\u7684\u65b9\u6cd5\uff0c\u8fd9\u662f\u7c7b\u4f3c\u4e8e\u63d2\u4ef6 callback \u7684\u7edf\u4e00\u63a5\u53e3\u3002\u5982\u679c\u5b9a\u4e49\u4e3a\u5176\u5b83\u7c7b\u578b\uff0c\u5b83\u4e0d\u4f1a\u751f\u6548\uff0c\u5e76\u4e14\u4f1a\u6253\u5370\u4e00\u4e2a\u8b66\u544a\u65e5\u5fd7\uff0c\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"hooks.html"},"Hook")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (user *User) BeforeCreate(tx *gorm.DB) error {\n  // \u901a\u8fc7 tx.Statement \u4fee\u6539\u5f53\u524d\u64cd\u4f5c\uff0c\u4f8b\u5982\uff1a\n  tx.Statement.Select("Name", "Age")\n  tx.Statement.AddClause(clause.OnConflict{DoNothing: true})\n\n  // \u9664\u4e86\u5f53\u524d\u5b50\u53e5\uff0c\u57fa\u4e8e tx \u7684\u64cd\u4f5c\u4f1a\u8fd0\u884c\u5728\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\n  var role Role\n  err := tx.First(&role, "name = ?", user.Role).Error\n  // SELECT * FROM roles WHERE name = "admin"\n  return err\n}\n')),(0,l.kt)("h4",{id:"update-hook-\u652f\u6301-changed"},"Update Hook \u652f\u6301 ",(0,l.kt)("inlineCode",{parentName:"h4"},"Changed")),(0,l.kt)("p",null,"\u5f53\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"Update"),"\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"Updates")," \u66f4\u65b0\u65f6\uff0c\u60a8\u53ef\u4ee5\u5728 ",(0,l.kt)("inlineCode",{parentName:"p"},"BeforeUpdate"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"BeforeSave")," Hook \u4e2d\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"Changed")," \u65b9\u6cd5\u6765\u68c0\u67e5\u5b57\u6bb5\u662f\u5426\u6709\u66f4\u6539"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'func (user *User) BeforeUpdate(tx *gorm.DB) error {\n  if tx.Statement.Changed("Name", "Admin") { // if Name or Admin changed\n    tx.Statement.SetColumn("Age", 18)\n  }\n\n  if tx.Statement.Changed() { // \u5982\u679c\u4efb\u4f55\u5b57\u6bb5\u6709\u53d8\u52a8\n    tx.Statement.SetColumn("Age", 18)\n  }\n  return nil\n}\n\ndb.Model(&user).Update("Name", "Jinzhu") // update field `Name` to `Jinzhu`\ndb.Model(&user).Updates(map[string]interface{}{"name": "Jinzhu", "admin": false}) // update field `Name` to `Jinzhu`, `Admin` to false\ndb.Model(&user).Updates(User{Name: "Jinzhu", Admin: false}) // Update none zero fields when using struct as argument, will only update `Name` to `Jinzhu`\n\ndb.Model(&user).Select("Name", "Admin").Updates(User{Name: "Jinzhu"}) // update selected fields `Name`, `Admin`\uff0c`Admin` will be updated to zero value (false)\ndb.Model(&user).Select("Name", "Admin").Updates(map[string]interface{}{"Name": "Jinzhu"}) // update selected fields exists in the map, will only update field `Name` to `Jinzhu`\n\n// Attention: `Changed` will only check the field value of `Update` / `Updates` equals `Model`\'s field value, it returns true if not equal and the field will be saved\ndb.Model(&User{ID: 1, Name: "jinzhu"}).Updates(map[string]interface{"name": "jinzhu2"}) // Changed("Name") => true\ndb.Model(&User{ID: 1, Name: "jinzhu"}).Updates(map[string]interface{"name": "jinzhu"}) // Changed("Name") => false, `Name` not changed\ndb.Model(&User{ID: 1, Name: "jinzhu"}).Select("Admin").Updates(map[string]interface{"name": "jinzhu2", "admin": false}) // Changed("Name") => false, `Name` not selected to update\n\ndb.Model(&User{ID: 1, Name: "jinzhu"}).Updates(User{Name: "jinzhu2"}) // Changed("Name") => true\ndb.Model(&User{ID: 1, Name: "jinzhu"}).Updates(User{Name: "jinzhu"})  // Changed("Name") => false, `Name` not changed\ndb.Model(&User{ID: 1, Name: "jinzhu"}).Select("Admin").Updates(User{Name: "jinzhu2"}) // Changed("Name") => false, `Name` not selected to update\n')),(0,l.kt)("h4",{id:"\u63d2\u4ef6"},"\u63d2\u4ef6"),(0,l.kt)("p",null,"\u63d2\u4ef6 callback \u4e5f\u9700\u8981\u88ab\u5b9a\u4e49\u4e3a ",(0,l.kt)("inlineCode",{parentName:"p"},"func(tx *gorm.DB) error")," \u7c7b\u578b\u7684\u65b9\u6cd5\uff0c\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"write_plugins.html"},"Write Plugins")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"\u4f7f\u7528-struct-\u66f4\u65b0"},"\u4f7f\u7528 struct \u66f4\u65b0"),(0,l.kt)("p",null,"\u4f7f\u7528 struct \u66f4\u65b0\u65f6\uff0cGORM V2 \u5141\u8bb8\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"Select")," \u6765\u9009\u62e9\u8981\u66f4\u65b0\u7684\u96f6\u503c\u5b57\u6bb5\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Model(&user).Select("Role", "Age").Update(User{Name: "jinzhu", Role: "", Age: 0})\n')),(0,l.kt)("h4",{id:"\u5173\u8054"},"\u5173\u8054"),(0,l.kt)("p",null,"GORM V1\u5141\u8bb8\u4f7f\u7528\u4e00\u4e9b\u8bbe\u7f6e\u6765\u8df3\u8fc7 create/update \u5173\u8054\u3002\u5728 V2 \u4e2d\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"Select")," \u6765\u5b8c\u6210\u8fd9\u9879\u5de5\u4f5c\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'db.Omit(clause.Associations).Create(&user)\ndb.Omit(clause.Associations).Save(&user)\n\ndb.Select("Company").Save(&user)\n')),(0,l.kt)("p",null,"\u6b64\u5916\uff0cGORM V2 \u4e0d\u518d\u5141\u8bb8\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"p"},'Set("gorm:auto_preload", true)')," \u8fdb\u884c\u9884\u52a0\u8f7d\uff0c\u4f60\u53ef\u4ee5\u5c06 ",(0,l.kt)("inlineCode",{parentName:"p"},"Preload")," \u548c ",(0,l.kt)("inlineCode",{parentName:"p"},"clause.Associations")," \u914d\u5408\u4f7f\u7528\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"// \u9884\u52a0\u8f7d\u6240\u6709\u5173\u8054\ndb.Preload(clause.Associations).Find(&users)\n")),(0,l.kt)("p",null,"\u6b64\u5916\uff0c\u8fd8\u53ef\u4ee5\u67e5\u770b\u5b57\u6bb5\u6743\u9650\uff0c\u5b83\u53ef\u4ee5\u7528\u6765\u5168\u5c40\u8df3\u8fc7 creating/updating \u5173\u8054"),(0,l.kt)("p",null,"\u5728\u521b\u5efa\u3001\u66f4\u65b0\u8bb0\u5f55\u65f6\uff0cGORM V2 \u5c06\u4f7f\u7528 upsert \u6765\u4fdd\u5b58\u5173\u8054\u8bb0\u5f55\u3002\u4e0d\u4f1a\u518d\u4fdd\u5b58\u5b8c\u6574\u7684\u5173\u8054\u6570\u636e\uff0c\u907f\u514d\u53d7\u672a\u5b8c\u6210\u6570\u636e\u7684\u5f71\u54cd\uff0c\u4ee5\u4fdd\u62a4\u60a8\u7684\u6570\u636e\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'user := User{\n  Name:            "jinzhu",\n  BillingAddress:  Address{Address1: "Billing Address - Address 1"},\n  ShippingAddress: Address{Address1: "Shipping Address - Address 1"},\n  Emails:          []Email{\n    {Email: "jinzhu@example.com"},\n    {Email: "jinzhu-2@example.com"},\n  },\n  Languages:       []Language{\n    {Name: "ZH"},\n    {Name: "EN"},\n  },\n}\n\ndb.Create(&user)\n// BEGIN TRANSACTION;\n// INSERT INTO "addresses" (address1) VALUES ("Billing Address - Address 1"), ("Shipping Address - Address 1") ON DUPLICATE KEY DO NOTHING;\n// INSERT INTO "users" (name,billing_address_id,shipping_address_id) VALUES ("jinzhu", 1, 2);\n// INSERT INTO "emails" (user_id,email) VALUES (111, "jinzhu@example.com"), (111, "jinzhu-2@example.com") ON DUPLICATE KEY DO NOTHING;\n// INSERT INTO "languages" ("name") VALUES (\'ZH\'), (\'EN\') ON DUPLICATE KEY DO NOTHING;\n// INSERT INTO "user_languages" ("user_id","language_id") VALUES (111, 1), (111, 2) ON DUPLICATE KEY DO NOTHING;\n// COMMIT;\n')),(0,l.kt)("h4",{id:"join-table"},"Join Table"),(0,l.kt)("p",null,"\u5728 GORM V2 \u4e2d\uff0c",(0,l.kt)("inlineCode",{parentName:"p"},"JoinTable")," \u53ef\u4ee5\u662f\u4e00\u4e2a\u5e26\u6709 ",(0,l.kt)("inlineCode",{parentName:"p"},"\u8f6f\u5220\u9664"),"\u3001",(0,l.kt)("inlineCode",{parentName:"p"},"Hook")," \u4e14\u5b9a\u4e49\u4e86\u5176\u5b83\u5b57\u6bb5\u7684\u5168\u529f\u80fd model\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'type Person struct {\n  ID        int\n  Name      string\n  Addresses []Address `gorm:"many2many:person_addresses;"`\n}\n\ntype Address struct {\n  ID   uint\n  Name string\n}\n\ntype PersonAddress struct {\n  PersonID  int\n  AddressID int\n  CreatedAt time.Time\n  DeletedAt gorm.DeletedAt\n}\n\nfunc (PersonAddress) BeforeCreate(db *gorm.DB) error {\n  // ...\n}\n\n// PersonAddress \u5fc5\u987b\u5b9a\u4e49\u597d\u6240\u9700\u7684\u5916\u952e\uff0c\u5426\u5219\u4f1a\u62a5\u9519\nerr := db.SetupJoinTable(&Person{}, "Addresses", &PersonAddress{})\n')),(0,l.kt)("p",null,"\u7136\u540e\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6807\u51c6\u7684 GORM \u65b9\u6cd5\u6765\u64cd\u4f5c\u8fde\u63a5\u8868\u7684\u6570\u636e\uff0c\u4f8b\u5982\uff1a"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'var results []PersonAddress\ndb.Where("person_id = ?", person.ID).Find(&results)\n\ndb.Where("address_id = ?", address.ID).Delete(&PersonAddress{})\n\ndb.Create(&PersonAddress{PersonID: person.ID, AddressID: address.ID})\n')),(0,l.kt)("h4",{id:"count"},"Count"),(0,l.kt)("p",null,"Count \u4ec5\u652f\u6301 ",(0,l.kt)("inlineCode",{parentName:"p"},"*int64")," \u4f5c\u4e3a\u53c2\u6570"),(0,l.kt)("h4",{id:"\u4e8b\u52a1"},"\u4e8b\u52a1"),(0,l.kt)("p",null,"\u79fb\u9664\u4e86 ",(0,l.kt)("inlineCode",{parentName:"p"},"RollbackUnlessCommitted")," \u4e4b\u7c7b\u7684\u4e8b\u52a1\u65b9\u6cd5\uff0c\u5efa\u8bae\u4f7f\u7528 ",(0,l.kt)("inlineCode",{parentName:"p"},"Transaction")," \u65b9\u6cd5\u5305\u88f9\u4e8b\u52a1"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},"db.Transaction(func(tx *gorm.DB) error {\n  // \u5728\u4e8b\u52a1\u4e2d\u6267\u884c\u4e00\u4e9b db \u64cd\u4f5c\uff08\u4ece\u8fd9\u91cc\u5f00\u59cb\uff0c\u60a8\u5e94\u8be5\u4f7f\u7528 'tx' \u800c\u4e0d\u662f 'db'\uff09\n  if err := tx.Create(&Animal{Name: \"Giraffe\"}).Error; err != nil {\n    // \u8fd4\u56de\u4efb\u4f55\u9519\u8bef\u90fd\u4f1a\u56de\u6eda\u4e8b\u52a1\n    return err\n  }\n\n  if err := tx.Create(&Animal{Name: \"Lion\"}).Error; err != nil {\n    return err\n  }\n\n  // \u8fd4\u56de nil \u63d0\u4ea4\u4e8b\u52a1\n  return nil\n})\n")),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"transactions.html"},"\u4e8b\u52a1")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("h4",{id:"migrator"},"Migrator"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Migrator \u9ed8\u8ba4\u4f1a\u521b\u5efa\u6570\u636e\u5e93\u5916\u952e"),(0,l.kt)("li",{parentName:"ul"},"Migrator \u66f4\u52a0\u72ec\u7acb\uff0c\u91cd\u547d\u540d\u4e86\u5f88\u591a API\uff0c\u4ee5\u4fbf\u4f7f\u7528\u7edf\u4e00 API \u63a5\u53e3\u4e3a\u6bcf\u4e2a\u6570\u636e\u5e93\u63d0\u4f9b\u66f4\u597d\u7684\u652f\u6301"),(0,l.kt)("li",{parentName:"ul"},"\u5982\u679c\u5927\u5c0f\u3001\u7cbe\u5ea6\u3001\u662f\u5426\u4e3a\u7a7a\u53ef\u4ee5\u66f4\u6539\uff0c\u5219 AutoMigrate \u4f1a\u6539\u53d8\u5217\u7684\u7c7b\u578b"),(0,l.kt)("li",{parentName:"ul"},"\u901a\u8fc7 ",(0,l.kt)("inlineCode",{parentName:"li"},"check")," \u6807\u7b7e\u652f\u6301\u68c0\u67e5\u5668"),(0,l.kt)("li",{parentName:"ul"},"\u589e\u5f3a ",(0,l.kt)("inlineCode",{parentName:"li"},"index")," \u6807\u7b7e\u7684\u8bbe\u7f6e")),(0,l.kt)("p",null,"\u67e5\u770b ",(0,l.kt)("a",{parentName:"p",href:"migration.html"},"Migration")," \u83b7\u53d6\u8be6\u60c5"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-go"},'type UserIndex struct {\n  Name  string `gorm:"check:named_checker,(name <> \'jinzhu\')"`\n  Name2 string `gorm:"check:(age > 13)"`\n  Name4 string `gorm:"index"`\n  Name5 string `gorm:"index:idx_name,unique"`\n  Name6 string `gorm:"index:,sort:desc,collate:utf8,type:btree,length:10,where:name3 != \'jinzhu\'"`\n}\n')),(0,l.kt)("h2",{id:"happy-hacking"},"Happy Hacking"))}g.isMDXComponent=!0}}]);